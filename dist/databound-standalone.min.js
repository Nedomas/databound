var Databound,DataboundError,__slice=[].slice;Databound=function(){function t(t,e,r){this.endpoint=t,this.scope=null!=e?e:{},this.options=null!=r?r:{},this.extra_where_scopes=this.options.extra_where_scopes||[],this.records=[],this.seeds=[],this.properties=[]}return t.API_URL="",t.prototype.request=function(t,e){return jQuery.post(this.url(t),this.data(e),"json")},t.prototype.promise=function(t){var e;return e=jQuery.Deferred(),e.resolve(t),e.promise()},t.prototype.where=function(t){var e;return e=this,this.wrappedRequest("where",t).then(function(t){var r;return r=JSON.parse(t.records).concat(e.seeds),e.records=_.sortBy(r,"id"),e.promise(e.records)})},t.prototype.all=function(){return this.where()},t.prototype.find=function(t){var e;return this.checkUndefinedId("find",t),e=this,this.where({id:t}).then(function(){var r;if(r=e.take(t),!r)throw new DataboundError("Couldn't find record with id: "+t);return e.promise(r)})},t.prototype.findBy=function(t){var e;return e=this,this.where(t).then(function(t){return e.promise(_.first(_.values(t)))})},t.prototype.create=function(t){return this.requestAndRefresh("create",t)},t.prototype.update=function(t){return this.requestAndRefresh("update",t)},t.prototype.destroy=function(t){return this.checkUndefinedId("destroy",t),this.requestAndRefresh("destroy",{id:t})},t.prototype.take=function(t){return _.detect(this.records,function(e){return t.toString()===e.id.toString()})},t.prototype.takeAll=function(){return this.records},t.prototype.injectSeedRecords=function(t){return this.seeds=t},t.prototype.requestAndRefresh=function(t,e){var r;return r=this,this.wrappedRequest(t,e).then(function(t){var e,n;return e=JSON.parse(t.scoped_records),n=e.concat(r.seeds),r.records=_.sortBy(n,"id"),r.promise(t.id?r.take(t.id):t.success)})},t.prototype.url=function(e){return _.isEmpty(t.API_URL)?""+this.endpoint+"/"+e:""+t.API_URL+"/"+this.endpoint+"/"+e},t.prototype.data=function(t){return{scope:JSON.stringify(this.scope),extra_where_scopes:JSON.stringify(this.extra_where_scopes),data:JSON.stringify(t)}},t.prototype.wrappedRequest=function(){var t;return t=1<=arguments.length?__slice.call(arguments,0):[],this.request.apply(this,t).then(this.handleSuccess).fail(this.handleFailure)},t.prototype.handleSuccess=function(t){if(!(null!=t?t.success:void 0))throw new Error("Error in the backend");return this.promise(t)},t.prototype.handleFailure=function(t){throw 405===t.status?new DataboundError(t.responseJSON.message):new Error("Error in the backend with status "+t.status)},t.prototype.checkUndefinedId=function(t,e){if(_.isUndefined(e))throw new DataboundError("Couldn't "+t+" a record without an id")},t}(),DataboundError=function(){function t(t){this.message="Databound: "+t}return t}(),DataboundError.prototype=new Error;